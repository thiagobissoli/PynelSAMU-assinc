{% extends "base.html" %}

{% block title %}{% if modo == 'create' %}Criar{% else %}Editar{% endif %} Indicador - Sistema SAMU{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
.cor-swatch { width: 28px; height: 28px; border: 2px solid #dee2e6; border-radius: 4px; padding: 0; cursor: pointer; margin-right: 4px; margin-bottom: 4px; }
.cor-swatch:hover { border-color: #adb5bd; }
.cor-swatch.selected { border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13,110,253,0.25); }
.meta-estilo-opt svg { display: block; }
.meta-estilo-opt { padding: 8px 12px; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-{% if modo == 'create' %}plus-circle{% else %}pencil{% endif %}"></i> 
        {% if modo == 'create' %}Criar{% else %}Editar{% endif %} Indicador
    </h1>
    <a href="{{ url_for('indicadores.config') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <form method="POST" id="formIndicador">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Informações Básicas</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="nome" class="form-label">Nome do Indicador <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nome" name="nome" 
                               value="{{ indicador.nome if indicador else '' }}" required>
                        <small class="form-text text-muted">Ex: Tempo resposta vermelho APH</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="2">{{ indicador.descricao if indicador else '' }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipo_calculo" class="form-label">Tipo de Cálculo <span class="text-danger">*</span></label>
                            <select class="form-select no-select2" id="tipo_calculo" name="tipo_calculo" required>
                                <option value="diferenca_tempo" {% if indicador and indicador.tipo_calculo == 'diferenca_tempo' %}selected{% endif %}>Diferença de Tempo</option>
                                <option value="contagem" {% if indicador and indicador.tipo_calculo == 'contagem' %}selected{% endif %}>Contagem</option>
                                <option value="media" {% if indicador and indicador.tipo_calculo == 'media' %}selected{% endif %}>Média</option>
                                <option value="soma" {% if indicador and indicador.tipo_calculo == 'soma' %}selected{% endif %}>Soma</option>
                                <option value="percentual_meta" {% if indicador and indicador.tipo_calculo == 'percentual_meta' %}selected{% endif %}>% que atinge a meta</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="unidade" class="form-label">Unidade</label>
                            <select class="form-select no-select2" id="unidade" name="unidade">
                                <option value="segundos" {% if indicador and indicador.unidade == 'segundos' %}selected{% endif %}>Segundos</option>
                                <option value="minutos" {% if indicador and indicador.unidade == 'minutos' or not indicador %}selected{% endif %}>Minutos</option>
                                <option value="horas" {% if indicador and indicador.unidade == 'horas' %}selected{% endif %}>Horas</option>
                                <option value="dias" {% if indicador and indicador.unidade == 'dias' %}selected{% endif %}>Dias</option>
                                <option value="ocorrências" {% if indicador and indicador.unidade == 'ocorrências' %}selected{% endif %}>Ocorrências</option>
                                <option value="regulações" {% if indicador and indicador.unidade == 'regulações' %}selected{% endif %}>Regulações</option>
                                <option value="empenhos" {% if indicador and indicador.unidade == 'empenhos' %}selected{% endif %}>Empenhos</option>
                                <option value="%" {% if indicador and indicador.unidade == '%' %}selected{% endif %}>%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row" id="campos_tempo" style="display: {% if indicador and indicador.tipo_calculo in ['diferenca_tempo', 'percentual_meta'] or not indicador %}block{% else %}none{% endif %};">
                        <div class="col-md-6 mb-3">
                            <label for="coluna_data_inicio" class="form-label">Coluna Data Início</label>
                            <select class="form-select" id="coluna_data_inicio" name="coluna_data_inicio">
                                <option value="">Selecione...</option>
                                {% for coluna in colunas %}
                                <option value="{{ coluna }}" {% if indicador and indicador.coluna_data_inicio == coluna %}selected{% endif %}>{{ coluna }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="coluna_data_fim" class="form-label">Coluna Data Fim</label>
                            <select class="form-select" id="coluna_data_fim" name="coluna_data_fim">
                                <option value="">Selecione...</option>
                                {% for coluna in colunas %}
                                <option value="{{ coluna }}" {% if indicador and indicador.coluna_data_fim == coluna %}selected{% endif %}>{{ coluna }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row" id="campos_numerico" style="display: {% if indicador and indicador.tipo_calculo in ['media', 'soma'] %}block{% else %}none{% endif %};">
                        <div class="col-md-12 mb-3">
                            <label for="coluna_numerica" class="form-label">Coluna Numérica</label>
                            <select class="form-select" id="coluna_numerica" name="coluna_data_fim">
                                <option value="">Selecione...</option>
                                {% for coluna in colunas %}
                                <option value="{{ coluna }}" {% if indicador and indicador.coluna_data_fim == coluna %}selected{% endif %}>{{ coluna }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Meta (para % que atinge a meta) -->
                    <div class="row" id="campos_meta" style="display: {% if indicador and indicador.tipo_calculo == 'percentual_meta' %}block{% else %}none{% endif %};">
                        <div class="col-12 mb-3">
                            <div class="card border-info">
                                <div class="card-body py-3">
                                    <label class="form-label fw-bold">Meta</label>
                                    <p class="small text-muted mb-2">Indicador mostrará a % de registros que atingem a meta (ex.: tempo de resposta ≤ 15 min).</p>
                                    <div class="row">
                                        <div class="col-md-4 mb-2 mb-md-0">
                                            <label for="meta_valor" class="form-label">Valor da meta</label>
                                            <input type="number" step="any" class="form-control" id="meta_valor" name="meta_valor" 
                                                   value="{{ indicador.meta_valor if (indicador and indicador.meta_valor is not none) else '' }}" 
                                                   placeholder="Ex: 15">
                                            <small class="form-text text-muted">Na mesma unidade da medida (ex.: 15 = 15 min)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="meta_operador" class="form-label">Atinge quando</label>
                                            <select class="form-select" id="meta_operador" name="meta_operador">
                                                <option value="<=" {% if indicador and (indicador.meta_operador or '') == '<=' %}selected{% endif %}>≤ (menor ou igual)</option>
                                                <option value=">=" {% if indicador and (indicador.meta_operador or '') == '>=' %}selected{% endif %}>≥ (maior ou igual)</option>
                                            </select>
                                            <small class="form-text text-muted">Ex.: ≤ para “tempo ≤ 15 min é meta”</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ordem" class="form-label">Ordem de Exibição</label>
                            <input type="number" class="form-control" id="ordem" name="ordem" 
                                   value="{{ indicador.ordem if indicador else 0 }}" min="0">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="ativo" name="ativo" 
                                       {% if not indicador or indicador.ativo %}checked{% endif %}>
                                <label class="form-check-label" for="ativo">
                                    Indicador Ativo
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Média Móvel -->
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Média Móvel</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Média Móvel:</strong> Define a janela de tempo para cálculo do valor do indicador e dos pontos do gráfico.
                        Por exemplo, se configurar 2 horas, o valor exibido será a média dos dados das últimas 2 horas,
                        e cada ponto do gráfico também representará uma média de 2 horas.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="filtro_ultimas_horas" class="form-label">
                                <strong>Janela da Média Móvel (horas)</strong> <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="filtro_ultimas_horas" name="filtro_ultimas_horas" 
                                   value="{{ indicador.filtro_ultimas_horas if indicador and indicador.filtro_ultimas_horas else '2' }}" 
                                   min="1" placeholder="Ex: 2">
                            <small class="form-text text-muted">
                                Cada ponto do gráfico será a média dos dados das últimas X horas. 
                                Valor recomendado: 1-4 horas
                            </small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="coluna_data_filtro" class="form-label">
                                <strong>Coluna de Data/Hora</strong> <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="coluna_data_filtro" name="coluna_data_filtro">
                                <option value="">Selecione...</option>
                                {% for coluna in colunas %}
                                <option value="{{ coluna }}" {% if (indicador and indicador.coluna_data_filtro == coluna) or ((not indicador or not indicador.coluna_data_filtro) and coluna == 'Data ocorrência') %}selected{% endif %}>{{ coluna }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Coluna usada para determinar a idade dos registros</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Configuração de Gráfico -->
            <div class="card mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Configuração de Gráfico</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="grafico_habilitado" name="grafico_habilitado" 
                                   {% if indicador and indicador.grafico_habilitado %}checked{% endif %}>
                            <label class="form-check-label" for="grafico_habilitado">
                                <strong>Habilitar Gráfico</strong>
                            </label>
                        </div>
                        <small class="form-text text-muted">Exibir gráfico histórico no painel</small>
                    </div>
                    
                    <div id="campos_grafico" style="display: {% if indicador and indicador.grafico_habilitado %}block{% else %}none{% endif %};">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="grafico_ultimas_horas" class="form-label">Período do Gráfico (horas)</label>
                                <input type="number" class="form-control" id="grafico_ultimas_horas" name="grafico_ultimas_horas" 
                                       value="{{ indicador.grafico_ultimas_horas if indicador and indicador.grafico_ultimas_horas else 12 }}" 
                                       min="1" placeholder="Ex: 12">
                                <small class="form-text text-muted">Últimas X horas para o gráfico</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="grafico_intervalo_minutos" class="form-label">Intervalo (minutos)</label>
                                <input type="number" class="form-control" id="grafico_intervalo_minutos" name="grafico_intervalo_minutos" 
                                       value="{{ indicador.grafico_intervalo_minutos if indicador and indicador.grafico_intervalo_minutos else 60 }}" 
                                       min="1" placeholder="Ex: 60">
                                <small class="form-text text-muted">Intervalo entre pontos do gráfico</small>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="grafico_historico_habilitado" name="grafico_historico_habilitado" 
                                   {% if indicador and indicador.grafico_historico_habilitado %}checked{% endif %}>
                            <label class="form-check-label" for="grafico_historico_habilitado">
                                <strong>Exibir linha histórica no gráfico</strong>
                            </label>
                        </div>
                        <small class="form-text text-muted d-block mb-2">Informe os valores esperados para cada hora de cada mês. O gráfico exibirá automaticamente a média do mês atual.</small>
                        
                        <div id="campos_historico" style="display: {% if indicador and indicador.grafico_historico_habilitado %}block{% else %}none{% endif %};">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Cor da linha histórica</label>
                                    <div class="cor-swatches d-flex flex-wrap" data-input="grafico_historico_cor">
                                        <button type="button" class="cor-swatch" data-value="#6c757d" style="background:#6c757d" title="#6c757d"></button>
                                        <button type="button" class="cor-swatch" data-value="#0d6efd" style="background:#0d6efd" title="#0d6efd"></button>
                                        <button type="button" class="cor-swatch" data-value="#fd7e14" style="background:#fd7e14" title="#fd7e14"></button>
                                        <button type="button" class="cor-swatch" data-value="#6f42c1" style="background:#6f42c1" title="#6f42c1"></button>
                                        <button type="button" class="cor-swatch" data-value="#20c997" style="background:#20c997" title="#20c997"></button>
                                    </div>
                                    <input type="hidden" name="grafico_historico_cor" id="grafico_historico_cor" value="{{ indicador.grafico_historico_cor or '#6c757d' if indicador else '#6c757d' }}">
                                </div>
                            </div>
                            {% set meses_nomes = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'] %}
                            {% set hist_geral = indicador.get_historico_dados_dict() if indicador else {} %}
                            {% set formato_por_mes = hist_geral and hist_geral.get('01') is mapping %}
                            <ul class="nav nav-tabs mb-3 flex-nowrap overflow-auto" id="historicoTabs" role="tablist" style="flex-wrap: nowrap;">
                                {% for mes in range(1, 13) %}
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if loop.first %}active{% endif %}" id="tab-mes-{{ '%02d'|format(mes) }}" data-bs-toggle="tab" data-bs-target="#pane-mes-{{ '%02d'|format(mes) }}" type="button" role="tab" data-mes="{{ mes }}">
                                        {{ meses_nomes[loop.index0] }}
                                    </button>
                                </li>
                                {% endfor %}
                            </ul>
                            <p class="small text-muted mb-2">O gráfico exibe a média do mês atual (<strong id="mes-atual-label">—</strong>).</p>
                            <div class="tab-content" id="historicoTabContent">
                                {% for mes in range(1, 13) %}
                                {% set mes_key = '%02d'|format(mes) %}
                                {% set hist = hist_geral.get(mes_key, {}) if formato_por_mes and mes_key in hist_geral else (hist_geral if hist_geral and not formato_por_mes else {}) %}
                                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="pane-mes-{{ mes_key }}" role="tabpanel">
                                    <label class="form-label small">Valores por hora — {{ meses_nomes[loop.index0] }}</label>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered" style="max-width: 600px;">
                                            <thead><tr><th>Hora</th><th>Valor</th><th>Hora</th><th>Valor</th><th>Hora</th><th>Valor</th><th>Hora</th><th>Valor</th></tr></thead>
                                            <tbody>
                                            {% for row in range(6) %}
                                            <tr>
                                                {% for col in range(4) %}
                                                {% set h = row * 4 + col %}
                                                {% set h_str = '%02d'|format(h) %}
                                                {% set h_label = '%02d:00'|format(h) %}
                                                <td class="text-end">{{ h_label }}</td>
                                                <td><input type="number" step="any" class="form-control form-control-sm" name="historico_m{{ mes_key }}_h{{ h_str }}" value="{{ hist.get(h_str, hist.get(h_label, '')) }}" placeholder="—"></td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="grafico_meta_habilitado" name="grafico_meta_habilitado" 
                                   {% if indicador and indicador.grafico_meta_habilitado %}checked{% endif %}>
                            <label class="form-check-label" for="grafico_meta_habilitado">
                                <strong>Exibir linha de meta no gráfico</strong>
                            </label>
                        </div>
                        <div id="campos_grafico_meta" class="ms-4 mt-2" style="display: {% if indicador and indicador.grafico_meta_habilitado %}block{% else %}none{% endif %};">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-3">
                                    <label for="grafico_meta_valor" class="form-label small mb-0">Valor da meta</label>
                                    <input type="text" class="form-control form-control-sm" id="grafico_meta_valor" name="grafico_meta_valor" 
                                           value="{{ indicador.grafico_meta_valor if indicador and indicador.grafico_meta_valor is not none else '' }}" 
                                           placeholder="Ex: 15 ou 1,5 ou 1:30">
                                    <small class="form-text text-muted">Use 1,5 ou 1:30 para 1 min 30 seg</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small mb-0">Cor</label>
                                    <div class="cor-swatches d-flex flex-wrap" data-input="grafico_meta_cor">
                                        <button type="button" class="cor-swatch" data-value="#ffc107" style="background:#ffc107" title="#ffc107"></button>
                                        <button type="button" class="cor-swatch" data-value="#dc3545" style="background:#dc3545" title="#dc3545"></button>
                                        <button type="button" class="cor-swatch" data-value="#28a745" style="background:#28a745" title="#28a745"></button>
                                        <button type="button" class="cor-swatch" data-value="#0d6efd" style="background:#0d6efd" title="#0d6efd"></button>
                                        <button type="button" class="cor-swatch" data-value="#fd7e14" style="background:#fd7e14" title="#fd7e14"></button>
                                        <button type="button" class="cor-swatch" data-value="#6c757d" style="background:#6c757d" title="#6c757d"></button>
                                        <button type="button" class="cor-swatch" data-value="#6f42c1" style="background:#6f42c1" title="#6f42c1"></button>
                                        <button type="button" class="cor-swatch" data-value="#20c997" style="background:#20c997" title="#20c997"></button>
                                        <button type="button" class="cor-swatch" data-value="#17a2b8" style="background:#17a2b8" title="#17a2b8"></button>
                                        <button type="button" class="cor-swatch" data-value="#e83e8c" style="background:#e83e8c" title="#e83e8c"></button>
                                        <button type="button" class="cor-swatch" data-value="#6610f2" style="background:#6610f2" title="#6610f2"></button>
                                        <button type="button" class="cor-swatch" data-value="#ff6b6b" style="background:#ff6b6b" title="#ff6b6b"></button>
                                        <button type="button" class="cor-swatch" data-value="#51cf66" style="background:#51cf66" title="#51cf66"></button>
                                    </div>
                                    <input type="hidden" name="grafico_meta_cor" id="grafico_meta_cor" value="{{ indicador.grafico_meta_cor or '#ffc107' if indicador else '#ffc107' }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small mb-0">Estilo da linha</label>
                                    <div class="dropdown">
                                        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" id="btnMetaEstilo">
                                            <span id="metaEstiloPreview"></span>
                                        </button>
                                        <ul class="dropdown-menu" id="dropdownMetaEstilo">
                                            <li><a class="dropdown-item meta-estilo-opt" href="#" data-value="solid"><svg width="60" height="12" viewBox="0 0 60 12"><line x1="0" y1="6" x2="60" y2="6" stroke="#333" stroke-width="2"/></svg></a></li>
                                            <li><a class="dropdown-item meta-estilo-opt" href="#" data-value="dashed"><svg width="60" height="12" viewBox="0 0 60 12"><line x1="0" y1="6" x2="60" y2="6" stroke="#333" stroke-width="2" stroke-dasharray="5,5"/></svg></a></li>
                                            <li><a class="dropdown-item meta-estilo-opt" href="#" data-value="dotted"><svg width="60" height="12" viewBox="0 0 60 12"><line x1="0" y1="6" x2="60" y2="6" stroke="#333" stroke-width="2" stroke-dasharray="2,2"/></svg></a></li>
                                            <li><a class="dropdown-item meta-estilo-opt" href="#" data-value="long_dash"><svg width="60" height="12" viewBox="0 0 60 12"><line x1="0" y1="6" x2="60" y2="6" stroke="#333" stroke-width="2" stroke-dasharray="10,5"/></svg></a></li>
                                            <li><a class="dropdown-item meta-estilo-opt" href="#" data-value="dash_dot"><svg width="60" height="12" viewBox="0 0 60 12"><line x1="0" y1="6" x2="60" y2="6" stroke="#333" stroke-width="2" stroke-dasharray="8,4,2,4"/></svg></a></li>
                                        </ul>
                                    </div>
                                    <input type="hidden" name="grafico_meta_estilo" id="grafico_meta_estilo" value="{{ indicador.grafico_meta_estilo or 'dashed' if indicador else 'dashed' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Configuração de Tendência -->
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-arrow-up-right"></i> Configuração de Tendência</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i>
                        Defina como o indicador deve interpretar subidas e descidas nos valores.
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tendencia_inversa" name="tendencia_inversa" 
                                   {% if indicador and indicador.tendencia_inversa %}checked{% endif %}>
                            <label class="form-check-label" for="tendencia_inversa">
                                <strong>Menor é melhor</strong>
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            Marque para indicadores onde valores menores são melhores (ex: tempo de resposta).<br>
                            Desmarque quando valores maiores são melhores (ex: número de atendimentos).
                        </small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="bi bi-arrow-up"></i> Cor para Subida</label>
                            <div class="cor-swatches d-flex flex-wrap" data-input="cor_subida">
                                <button type="button" class="cor-swatch" data-value="#28a745" style="background:#28a745" title="#28a745"></button>
                                <button type="button" class="cor-swatch" data-value="#dc3545" style="background:#dc3545" title="#dc3545"></button>
                                <button type="button" class="cor-swatch" data-value="#0d6efd" style="background:#0d6efd" title="#0d6efd"></button>
                                <button type="button" class="cor-swatch" data-value="#fd7e14" style="background:#fd7e14" title="#fd7e14"></button>
                            </div>
                            <input type="hidden" name="cor_subida" id="cor_subida" value="{{ indicador.cor_subida or '#28a745' if indicador else '#28a745' }}">
                            <small class="form-text text-muted">Cor quando o valor sobe</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="bi bi-arrow-down"></i> Cor para Descida</label>
                            <div class="cor-swatches d-flex flex-wrap" data-input="cor_descida">
                                <button type="button" class="cor-swatch" data-value="#28a745" style="background:#28a745" title="#28a745"></button>
                                <button type="button" class="cor-swatch" data-value="#dc3545" style="background:#dc3545" title="#dc3545"></button>
                                <button type="button" class="cor-swatch" data-value="#0d6efd" style="background:#0d6efd" title="#0d6efd"></button>
                                <button type="button" class="cor-swatch" data-value="#fd7e14" style="background:#fd7e14" title="#fd7e14"></button>
                            </div>
                            <input type="hidden" name="cor_descida" id="cor_descida" value="{{ indicador.cor_descida or '#dc3545' if indicador else '#dc3545' }}">
                            <small class="form-text text-muted">Cor quando o valor desce</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-secondary mt-2">
                        <strong>Dica:</strong> Para tempo de resposta, marque "Menor é melhor" e use verde para descida (valores menores são bons).
                    </div>
                </div>
            </div>
            
            <!-- Contabilizar -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-calculator"></i> Contabilizar</h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">Várias linhas podem ter o mesmo número de ocorrência (ex.: várias ambulâncias no mesmo atendimento). Escolha se conta cada linha ou cada ocorrência única.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="contagem_por" id="contagem_linhas_ind" value="linhas" {% if not indicador or (indicador.contagem_por or 'linhas') == 'linhas' %}checked{% endif %}>
                                <label class="form-check-label" for="contagem_linhas_ind">Todas as linhas</label>
                            </div>
                            <small class="text-muted d-block ms-4">Cada linha do dado conta separadamente.</small>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="contagem_por" id="contagem_ocorrencia_ind" value="ocorrencia" {% if indicador and (indicador.contagem_por or '') == 'ocorrencia' %}checked{% endif %}>
                                <label class="form-check-label" for="contagem_ocorrencia_ind">Por ocorrência (uma por valor na coluna)</label>
                            </div>
                            <small class="text-muted d-block ms-4">Várias linhas com o mesmo valor na coluna contam como 1.</small>
                        </div>
                    </div>
                    <div id="coluna_ocorrencia_wrapper_ind" class="mt-3" style="display: {% if indicador and (indicador.contagem_por or '') == 'ocorrencia' %}block{% else %}none{% endif %};">
                        <label for="coluna_ocorrencia" class="form-label">Coluna que identifica a ocorrência</label>
                        <select class="form-select" id="coluna_ocorrencia" name="coluna_ocorrencia" style="max-width: 280px;">
                            <option value="">Selecione...</option>
                            {% for coluna in colunas %}
                            <option value="{{ coluna }}" {% if (indicador and (indicador.coluna_ocorrencia or '') == coluna) or ((not indicador or not indicador.coluna_ocorrencia) and coluna == 'Ocorrência') %}selected{% endif %}>{{ coluna }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Padrão: Ocorrência. Ex.: 6 linhas com a mesma Ocorrência = 1 ocorrência.</small>
                    </div>
                </div>
            </div>

            <!-- Condições -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel"></i> Condições de Filtro
                        <button type="button" class="btn btn-sm btn-light float-end" id="btnAdicionarCondicao">
                            <i class="bi bi-plus"></i> Adicionar Condição
                        </button>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="condicoesContainer">
                        {% if indicador %}
                            {% set conds = indicador.get_condicoes_dict() %}
                            {% for cond in conds %}
                            <div class="condicao-item mb-3 p-3 border rounded">
                                <div class="row align-items-end">
                                    <div class="col-md-2 col-6">
                                        <label class="form-label">Combinar com</label>
                                        <select class="form-select form-select-sm no-select2 condicao-conector" name="condicao_{{ loop.index0 }}_conector" {% if loop.index0 == 0 %}disabled{% endif %}>
                                            <option value="and" {% if loop.index0 == 0 or (cond.conector or 'and') == 'and' %}selected{% endif %}>E (AND)</option>
                                            <option value="or" {% if loop.index0 > 0 and cond.conector == 'or' %}selected{% endif %}>OU (OR)</option>
                                            <option value="if" {% if loop.index0 > 0 and cond.conector == 'if' %}selected{% endif %}>SE (IF)</option>
                                        </select>
                                        {% if loop.index0 == 0 %}<input type="hidden" name="condicao_{{ loop.index0 }}_conector" value="and">{% endif %}
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Coluna</label>
                                        <select class="form-select condicao-coluna" name="condicao_{{ loop.index0 }}_coluna" required>
                                            <option value="">Selecione...</option>
                                            {% for coluna in colunas %}
                                            <option value="{{ coluna }}" {% if cond.coluna == coluna %}selected{% endif %}>{{ coluna }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Operador</label>
                                        <select class="form-select condicao-operador no-select2" name="condicao_{{ loop.index0 }}_operador">
                                            <option value="==" {% if cond.operador == '==' %}selected{% endif %}>Igual (==)</option>
                                            <option value="!=" {% if cond.operador == '!=' %}selected{% endif %}>Diferente (!=)</option>
                                            <option value=">" {% if cond.operador == '>' %}selected{% endif %}>Maior (>)</option>
                                            <option value="<" {% if cond.operador == '<' %}selected{% endif %}>Menor (<)</option>
                                            <option value=">=" {% if cond.operador == '>=' %}selected{% endif %}>Maior ou Igual (>=)</option>
                                            <option value="<=" {% if cond.operador == '<=' %}selected{% endif %}>Menor ou Igual (<=)</option>
                                            <option value="contains" {% if cond.operador == 'contains' %}selected{% endif %}>Contém</option>
                                            <option value="not contains" {% if cond.operador == 'not contains' %}selected{% endif %}>Não Contém</option>
                                            <option value="is null" {% if cond.operador == 'is null' %}selected{% endif %}>É Nulo</option>
                                            <option value="is not null" {% if cond.operador == 'is not null' %}selected{% endif %}>Não É Nulo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Valor</label>
                                        <select class="form-select condicao-valor condicao-valor-select" name="condicao_{{ loop.index0 }}_valor" data-valor-inicial="{{ cond.valor or '' }}">
                                            <option value="">Selecione ou digite...</option>
                                            {% if cond.valor %}<option value="{{ cond.valor }}" selected>{{ cond.valor }}</option>{% endif %}
                                        </select>
                                        <small class="form-text text-muted">Escolha na lista (planilha) ou digite um valor novo</small>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-danger w-100 btn-remover-condicao">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <input type="hidden" id="num_condicoes" name="num_condicoes" value="{% if indicador %}{{ indicador.get_condicoes_dict()|length }}{% else %}0{% endif %}">
                    
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        Em cada condição, escolha como ela se combina com a anterior: <strong>E (AND)</strong>, <strong>OU (OR)</strong> ou <strong>SE (IF)</strong>. A primeira condição não tem conector.
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Salvar Indicador
                </button>
                <a href="{{ url_for('indicadores.config') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-question-circle"></i> Ajuda</h5>
            </div>
            <div class="card-body">
                <h6>Tipo de Cálculo:</h6>
                <ul class="small">
                    <li><strong>Diferença de Tempo:</strong> Calcula tempo entre duas datas</li>
                    <li><strong>Contagem:</strong> Conta registros que atendem às condições</li>
                    <li><strong>Média:</strong> Média de valores numéricos</li>
                    <li><strong>Soma:</strong> Soma de valores numéricos</li>
                </ul>
                
                <h6 class="mt-3">Operadores:</h6>
                <ul class="small">
                    <li><strong>==</strong>: Igual</li>
                    <li><strong>!=</strong>: Diferente</li>
                    <li><strong>contains</strong>: Contém texto</li>
                    <li><strong>is null</strong>: Campo vazio</li>
                </ul>
                
                <h6 class="mt-3">Exemplo:</h6>
                <p class="small">
                    <strong>Nome:</strong> Tempo resposta vermelho APH<br>
                    <strong>Tipo:</strong> Diferença de Tempo<br>
                    <strong>Data Início:</strong> Data ocorrência<br>
                    <strong>Data Fim:</strong> Chegada no local<br>
                    <strong>Condições:</strong><br>
                    - Atendimento == Com atendimento<br>
                    - Código da ocorrência == Vermelho<br>
                    - Transporte == Pré-hospitalar
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
(function() {
    var API_COLUNA_VALORES = "{{ url_for('indicadores.coluna_valores') }}";

    function loadValoresAndInitSelect2($row) {
        var $coluna = $row.find('.condicao-coluna');
        var $valor = $row.find('.condicao-valor-select');
        var col = ($coluna.val() || '').trim();
        var currentVal = $valor.val() || $valor.data('valor-inicial') || '';
        if ($valor.data('select2')) { try { $valor.select2('destroy'); } catch(e) {} }
        $valor.off('select2:select');
        $valor.empty().append('<option value="">Selecione ou digite...</option>');
        if (!col) {
            $valor.select2({ theme: 'bootstrap-5', width: '100%', tags: true, placeholder: 'Selecione ou digite...' });
            return;
        }
        $.ajax({
            url: API_COLUNA_VALORES,
            data: { coluna: col },
            dataType: 'json',
            success: function(vals) {
                if (!Array.isArray(vals)) vals = [];
                $valor.empty().append('<option value="">Selecione ou digite...</option>');
                vals.forEach(function(v) {
                    var opt = $('<option></option>').attr('value', v).text(v);
                    if (v === currentVal) opt.prop('selected', true);
                    $valor.append(opt);
                });
                if (currentVal && $valor.find('option[value="' + currentVal.replace(/"/g,'\\"') + '"]').length === 0) {
                    $valor.append($('<option></option>').attr('value', currentVal).text(currentVal).prop('selected', true));
                }
                $valor.select2({ theme: 'bootstrap-5', width: '100%', tags: true, placeholder: 'Selecione ou digite...' });
            },
            error: function(xhr, status, err) {
                console.error('coluna_valores error:', status, err, xhr.responseText);
                $valor.select2({ theme: 'bootstrap-5', width: '100%', tags: true, placeholder: 'Erro ao carregar. Digite o valor.' });
            }
        });
    }

    window.loadValoresAndInitSelect2 = function(rowEl) {
        var $r = (typeof jQuery !== 'undefined' && rowEl) ? (rowEl.jquery ? rowEl : jQuery(rowEl)) : null;
        if ($r && $r.length) loadValoresAndInitSelect2($r);
    };
    $(document).ready(function() {
        // Select2 nos dropdowns de colunas (exceto tipo_calculo, unidade, cores, operador, condicao-valor)
        $('select.form-select:not(.condicao-valor-select):not(.no-select2)').each(function() {
            $(this).select2({ theme: 'bootstrap-5', width: '100%' });
        });
        $('#condicoesContainer').on('change', '.condicao-coluna', function() {
            loadValoresAndInitSelect2($(this).closest('.condicao-item'));
        });
        $('.condicao-item').each(function() {
            loadValoresAndInitSelect2($(this));
        });
    });
})();
</script>
<script>
let contadorCondicoes = {{ indicador.get_condicoes_dict()|length if indicador else 0 }};

document.getElementById('btnAdicionarCondicao').addEventListener('click', function() {
    const container = document.getElementById('condicoesContainer');
    const index = contadorCondicoes++;
    
    const html = `
        <div class="condicao-item mb-3 p-3 border rounded">
            <div class="row align-items-end">
                <div class="col-md-2 col-6">
                    <label class="form-label">Combinar com</label>
                    <select class="form-select form-select-sm no-select2 condicao-conector" name="condicao_${index}_conector">
                        <option value="and">E (AND)</option>
                        <option value="or">OU (OR)</option>
                        <option value="if">SE (IF)</option>
                    </select>
                </div>
                <div class="col-md-3 col-6">
                    <label class="form-label">Coluna</label>
                    <select class="form-select condicao-coluna" name="condicao_${index}_coluna" required>
                        <option value="">Selecione...</option>
                        {% for coluna in colunas %}
                        <option value="{{ coluna }}">{{ coluna }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Operador</label>
                    <select class="form-select condicao-operador no-select2" name="condicao_${index}_operador">
                        <option value="==">Igual (==)</option>
                        <option value="!=">Diferente (!=)</option>
                        <option value=">">Maior (>)</option>
                        <option value="<">Menor (<)</option>
                        <option value=">=">Maior ou Igual (>=)</option>
                        <option value="<=">Menor ou Igual (<=)</option>
                        <option value="contains">Contém</option>
                        <option value="not contains">Não Contém</option>
                        <option value="is null">É Nulo</option>
                        <option value="is not null">Não É Nulo</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Valor</label>
                    <select class="form-select condicao-valor condicao-valor-select" name="condicao_${index}_valor">
                        <option value="">Selecione ou digite...</option>
                    </select>
                    <small class="form-text text-muted">Escolha na lista (planilha) ou digite um valor novo</small>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-danger w-100 btn-remover-condicao">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    atualizarNumCondicoes();
    var last = container.querySelector('.condicao-item:last-child');
    if (last) {
        if (window.jQuery) {
            jQuery(last).find('.condicao-coluna').each(function() {
                jQuery(this).select2({ theme: 'bootstrap-5', width: '100%' });
            });
        }
        if (window.loadValoresAndInitSelect2) window.loadValoresAndInitSelect2(last);
    }
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.btn-remover-condicao')) {
        e.target.closest('.condicao-item').remove();
        atualizarNumCondicoes();
    }
});

function atualizarNumCondicoes() {
    const num = document.querySelectorAll('#condicoesContainer .condicao-item').length;
    const el = document.getElementById('num_condicoes');
    if (el) el.value = num;
}

// Garantir num_condicoes correto antes de enviar (evita condições não salvas)
document.getElementById('formIndicador').addEventListener('submit', function() {
    atualizarNumCondicoes();
});

// Mostrar/ocultar campos baseado no tipo de cálculo
document.getElementById('tipo_calculo').addEventListener('change', function() {
    const tipo = this.value;
    const camposTempo = document.getElementById('campos_tempo');
    const camposNumerico = document.getElementById('campos_numerico');
    const camposMeta = document.getElementById('campos_meta');
    
    if (tipo === 'diferenca_tempo' || tipo === 'percentual_meta') {
        camposTempo.style.display = 'block';
        camposNumerico.style.display = 'none';
        if (camposMeta) camposMeta.style.display = (tipo === 'percentual_meta') ? 'block' : 'none';
    } else if (tipo === 'media' || tipo === 'soma') {
        camposTempo.style.display = 'none';
        camposNumerico.style.display = 'block';
        if (camposMeta) camposMeta.style.display = 'none';
    } else {
        camposTempo.style.display = 'none';
        camposNumerico.style.display = 'none';
        if (camposMeta) camposMeta.style.display = 'none';
    }
});

// Mostrar/ocultar campos de gráfico
document.getElementById('grafico_habilitado').addEventListener('change', function() {
    const camposGrafico = document.getElementById('campos_grafico');
    camposGrafico.style.display = this.checked ? 'block' : 'none';
});

// Mostrar/ocultar campos de linha histórica
document.getElementById('grafico_historico_habilitado').addEventListener('change', function() {
    const camposHistorico = document.getElementById('campos_historico');
    camposHistorico.style.display = this.checked ? 'block' : 'none';
});
// Mostrar/ocultar campos de linha de meta do gráfico
document.getElementById('grafico_meta_habilitado').addEventListener('change', function() {
    const el = document.getElementById('campos_grafico_meta');
    if (el) el.style.display = this.checked ? 'block' : 'none';
});
// Estilo da linha de meta: preview e seleção
(function() {
    var svgs = { solid: '<svg width="50" height="12" viewBox="0 0 50 12"><line x1="0" y1="6" x2="50" y2="6" stroke="currentColor" stroke-width="2"/></svg>',
        dashed: '<svg width="50" height="12" viewBox="0 0 50 12"><line x1="0" y1="6" x2="50" y2="6" stroke="currentColor" stroke-width="2" stroke-dasharray="5,5"/></svg>',
        dotted: '<svg width="50" height="12" viewBox="0 0 50 12"><line x1="0" y1="6" x2="50" y2="6" stroke="currentColor" stroke-width="2" stroke-dasharray="2,2"/></svg>',
        long_dash: '<svg width="50" height="12" viewBox="0 0 50 12"><line x1="0" y1="6" x2="50" y2="6" stroke="currentColor" stroke-width="2" stroke-dasharray="10,5"/></svg>',
        dash_dot: '<svg width="50" height="12" viewBox="0 0 50 12"><line x1="0" y1="6" x2="50" y2="6" stroke="currentColor" stroke-width="2" stroke-dasharray="8,4,2,4"/></svg>' };
    function atualizarPreview() {
        var v = (document.getElementById('grafico_meta_estilo') || {}).value || 'dashed';
        var el = document.getElementById('metaEstiloPreview');
        if (el) el.innerHTML = svgs[v] || svgs.dashed;
    }
    document.querySelectorAll('.meta-estilo-opt').forEach(function(a) {
        a.addEventListener('click', function(e) { e.preventDefault(); var v = this.dataset.value; document.getElementById('grafico_meta_estilo').value = v; atualizarPreview(); });
    });
    atualizarPreview();
})();
// Inicializar e tratar cliques nos swatches de cor
document.querySelectorAll('.cor-swatches').forEach(function(container) {
    var inputId = container.dataset.input;
    var input = document.getElementById(inputId);
    if (!input) return;
    var valorAtual = (input.value || '').trim();
    container.querySelectorAll('.cor-swatch').forEach(function(btn) {
        if ((btn.dataset.value || '').toLowerCase() === (valorAtual || '').toLowerCase()) {
            btn.classList.add('selected');
        }
        btn.addEventListener('click', function() {
            container.querySelectorAll('.cor-swatch').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            input.value = btn.dataset.value;
        });
    });
});
// Exibir mês atual na seção de histórico
(function() {
    const meses = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const el = document.getElementById('mes-atual-label');
    if (el) el.textContent = meses[new Date().getMonth()];
})();

// Mostrar/ocultar coluna de ocorrência conforme "Contabilizar"
document.querySelectorAll('input[name="contagem_por"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        var wrapper = document.getElementById('coluna_ocorrencia_wrapper_ind');
        wrapper.style.display = (this.value === 'ocorrencia') ? 'block' : 'none';
    });
});
</script>
{% endblock %}
